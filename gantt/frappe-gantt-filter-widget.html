<h4 id="GantCode" style="display: block;">Edit gantt code</h4>
<script>
    if (!document.querySelector(".dashboard-configuration")) {
        document.getElementById("GantCode").style.display = "none";
    }
</script>
<!-- Gantt container. Instead of using a title here, you should use a text element which supports multi language text in 2025.-->
<div id="gantt"></div>
<script>

    window.dkr = window.dkr || {};
    dkr.SPAProperties = dkr.SPAProperties || {};
    dkr.gantt = dkr.gantt || {};
    dkr.gantt.init = async function (hostname) {
        const isEditModeActive = document.querySelector(".dashboard-configuration");
        if (isEditModeActive) {
            dkr.ganttConfig.hideReportOnDashboard = false;
        }

        if (dkr.ganttConfig.hideReportOnDashboard) {
            const ganttParent = document.getElementById("GantCode").closest(".dashboard-designer-control-place");
            if (ganttParent) {
                let nextSibling = ganttParent.nextElementSibling;
                while (nextSibling) {
                    if (nextSibling.classList.contains("dashboard-designer-control-place")) {
                        nextSibling.style.display = "none";
                        break;
                    }
                    nextSibling = nextSibling.nextElementSibling;
                }
            }
        }

        if (!isEditModeActive && dkr.SPAProperties.initialPath) {
            return;
        }

        if (!dkr.SPAProperties.originalFetch) {
            dkr.SPAProperties.originalFetch = window.fetch;
        }
        if (!dkr.SPAProperties.initialPath) {
            dkr.SPAProperties.initialPath = window.location.pathname;
        }

        if (!dkr.ganttConfig) {
            alert('Gantt configuration is not defined');
            return;
        }
        const config = dkr.ganttConfig.endpoints[hostname];
        if (!config) {
            console.error('Invalid hostname');
            return;
        }



        window.fetch = async function (input, init) {
            const response = await dkr.SPAProperties.originalFetch.bind(window)(input, init);
            // Restore the original fetch if the path has changed / the user has navigated away from the dashboard
            if (window.location.pathname !== dkr.SPAProperties.initialPath) {
                window.fetch = dkr.SPAProperties.originalFetch;
                dkr.SPAProperties.initialPath = null;
                return response;
            }
            const url = typeof input === 'string' ? input : input.url;
            // Intercept the response of the configured report
            if (url.endsWith(`/api/db/${config.db}/app/${config.app}/report/${config.report}/data`)) {
                try {
                    const clonedResponse = response.clone();
                    // process the response data with the Gantt chart library
                    const responseData = await clonedResponse.json();
                    const columnIds = dkr.gantt.getColumnIds(responseData.settings.columns);
                    dkr.gantt.renderGanttChart(responseData, columnIds);
                    
                    // If the report is hidden on the dashboard, clear the values to prevent further processing
                    if (dkr.ganttConfig.hideReportOnDashboard) {
                        responseData.values = [];        
                    }

                    // Return a new response with the modified data
                    return new Response(JSON.stringify(responseData), {
                        status: response.status,
                        statusText: response.statusText,
                        headers: response.headers
                    });
                } catch (error) {
                    console.error('Error processing intercepted fetch response:', error);
                }
            }
            return response;
        };
        console.log("Gantt intilization executed.");
    }

    dkr.gantt.getColumnIds = function (columns) {
        const columnMap = {};
        columns.forEach(column => {
            columnMap[column.dataBaseColumn] = column.id;
        });
        return columnMap;
    }

    dkr.gantt.renderGanttChart = function (data, columnIds) {
        let tasks = []
        data.values.forEach(item => {
            const startCell = item.cells.find(cell => cell.columnId == columnIds[dkr.ganttConfig.columnNames.startDate]);
            const endCell = item.cells.find(cell => cell.columnId == columnIds[dkr.ganttConfig.columnNames.endDate]);
            const titleCell = item.cells.find(cell => cell.columnId == columnIds[dkr.ganttConfig.columnNames.title]);
            const parent = item.cells.find(cell => cell.columnId == columnIds[dkr.ganttConfig.columnNames.parent]);
            const progress = item.cells.find(cell => cell.columnId == columnIds[dkr.ganttConfig.columnNames.progress]);


            if (startCell && endCell && titleCell) {
                const taskStartDate = new Date(dkr.gantt.getCellValue(startCell));
                const taskEndDate = new Date(dkr.gantt.getCellValue(endCell));

                tasks.push({
                    id: dkr.gantt.getCellValue(item.cells.find(cell => cell.columnId == columnIds[dkr.ganttConfig.columnNames.id])),
                    name: dkr.gantt.getCellValue(titleCell),
                    start: startCell.value,
                    end: endCell.value,
                    dependencies: parent ? dkr.gantt.getCellValue(parent) : null,
                    progress: progress ? dkr.gantt.getCellValue(progress) : 0,
                });
            }
        });
        let onClickFunction = null;
        if (dkr.ganttConfig.showInModal) {
            onClickFunction = function (task) {
                //dkr.modaldashboard.displayWorkflow = function (instanceId, title, dimensions, openInEditMode, closeFunction)
                dkr.modaldashboard.displayWorkflow(task.id, task.name, null, true, null);
            }
        }
        document.getElementById("gantt").innerHTML = ""; // Clear the previous chart
        // Initialize the Gantt chart with the tasks and options
        var gantt = new Gantt("#gantt", tasks, {
            ...dkr.ganttConfig.options,
            readonly: true,
            view_modes: dkr.ganttConfig.viewModes.map(mode => Gantt.VIEW_MODE[mode.toString().toUpperCase()]).filter(Boolean),
            on_click: onClickFunction,
            popup: false
        });
    }
    dkr.gantt.getCellValue = function (cell) {
        return cell.formattedValue && cell.formattedValue.trim() !== '' ? cell.formattedValue : cell.value;
    }

    dkr.gantt.init(document.location.hostname);
    console.log("gantt logic executed");
</script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt/dist/frappe-gantt.css">
<script src="https://cdn.jsdelivr.net/npm/frappe-gantt/dist/frappe-gantt.umd.js"
    onload="dkr.gantt.init(document.location.hostname);"></script>